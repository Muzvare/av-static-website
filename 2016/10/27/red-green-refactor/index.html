<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Red Green Refactor (Against the Clock)</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />

</head>
<body class="x2016 x2016_10 x2016_10_27 x2016_10_27_red-green-refactor x2016_10_27_red-green-refactor_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#services">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#portfolio">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2016/10/27/red-green-refactor/">Red Green Refactor (Against the Clock)</a></h2>
        <h5 class='date'>27 Oct 2016</h5>
    <p>While the AsynVoter folks got down to mobbing on the first feature I got on with some solo-coding on payment end points for the new intermediate level Premium payment plans.  I did want to try out <a href="https://github.com/rebelidealist/stripe-ruby-mock">ruby-stripe-mock</a> because while I do like the absolutist cover and re-recordability of the vcr/puffing-billy sandbox, the number of additional files that need to be checked in make associated pull requests hard to decipher.  Case in point, the <a href="https://github.com/AgileVentures/WebsiteOne/pull/1366">pull request</a> generated from the day&rsquo;s solo-coding consists of 132 files, of which only about 10 are files that I edited.  It would be great if branch comparisons on GitHub and RubyMine could filter out auto-generated files.</p>

<p>Under the circumstances of having only a little time and wanting to move at speed, I stuck with our sandboxes.  I just needed these endpoints up to see if anyone would actually sponsor us at these new price points for these new offerings.  Maybe <a href="https://github.com/rebelidealist/stripe-ruby-mock">ruby-stripe-mock</a> would be a simple win, but I was still unsure about whether it would really sandbox the browser interaction.  My questions to the stripe-ruby-mock community in Gitter and and GitHub issues had not gained me much clarity.  I knew the CraftAcademy folks had had <a href="https://medium.com/craft-academy/keeping-it-simple-3e7d9b186015#.cvnpccp1f">some success with the gem</a>, but still I had less than an hour.</p>

<p>I went straight for new feature tests which were almost clones of existing ones:</p>
<pre class="highlight gherkin"><code>  <span class="kn">Scenario</span><span class="p">:</span> Sign up for premium mob membership
    <span class="nf">Given</span> I visit <span class="s">"/charges/new?plan=premiummob"</span>
    <span class="nf">And</span> I should not see <span class="s">"Sign Me Up For Premium!"</span>
    <span class="nf">And</span> I click <span class="s">"Sign Me Up For Premium Mob!"</span>
    <span class="nf">When</span> I fill in appropriate card details for premium mob
    <span class="nf">Then</span> I should see <span class="s">"Thanks, you're now an AgileVentures Premium MOB Member!"</span>
    <span class="nf">And</span> The user should receive a <span class="s">"Welcome to AgileVentures Premium MOB"</span> email
</code></pre>
<p>I now had four like this - ripe for a &ldquo;Scenario Outline&rdquo; to DRY things out, but it was not time to refactor yet.  Throughout this session I think I identified a critical point about when to refactor.  Don&rsquo;t refactor when you&rsquo;re in the process of creating new tests or new code.  Refactor when you have new tests and code in place and when the tests are green.  Old advice but is blazed bright on my cortex.  Also every time you DRY things out you introduce a dependency, you reduce an axis of freedom that might be needed by the next incoming feature.  Cautious with that DRYing and refactoring.</p>

<p>I commented out the feature for the f2f plan and focused on getting this single mob payment end point.  First stop was the incorrectly named <code>charges_controller</code> (who named it? me).  I knew now that really this should be the subscription (or possibly plan?) controller.  Refactor that later.  I adjusted the new method to support a premiummob template:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">new</span>
    <span class="n">render</span> <span class="s1">'premiummob'</span> <span class="n">and</span> <span class="k">return</span> <span class="k">if</span> <span class="n">premiummob?</span>
    <span class="n">render</span> <span class="s1">'premiumplus'</span> <span class="n">and</span> <span class="k">return</span> <span class="k">if</span> <span class="n">premiumplus?</span>
    <span class="n">render</span> <span class="s1">'premium'</span>
  <span class="k">end</span>
</code></pre>
<p>and added a private method:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">premiummob?</span>
    <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiummob'</span>
  <span class="k">end</span>
</code></pre>
<p>I noticed that our private <code>update_user_to_premium</code> was now out of date, and actually had an unidentified bug that meant new PremiumPlus users would not be represented properly.  I could fix that by creating a <code>plan_class</code> method that would correctly identify the plan type.  </p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">update_user_to_premium</span><span class="p">(</span><span class="n">stripe_customer</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="n">current_user</span>
    <span class="no">UpgradeUserToPremium</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="n">stripe_customer</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="no">PaymentSource</span><span class="o">::</span><span class="no">Stripe</span><span class="p">,</span> <span class="n">plan_class</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">plan_class</span>
    <span class="k">return</span> <span class="no">PremiumMob</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiumob'</span>
    <span class="k">return</span> <span class="no">PremiumPlus</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiumplus'</span>
    <span class="no">Premium</span>
  <span class="k">end</span>
</code></pre>
<p>Really I wanted my feature tests to include some mechanism to check that the correct plan type was being stored in the database, but that would require bleeding into another feature which would be displaying the plan types correctly for users.  Actually we did have that, but it only works for logged in members, and we still aren&rsquo;t requiring login for these payment end points.  I didn&rsquo;t want problems with account sign up preventing people from sign up, although now we have 20+ people signed up that starts to look a bit paranoid.  I can probably add that restriction in and get feature tests that are not too tied to the database, but I chose not to get side-tracked by that right there and then.</p>

<p>I updated the various view templates and ran the feature test. It was failing on the email step.  I needed to support more acknowledgement email templates.  I let the code expand again:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">plan_name</span>
    <span class="k">return</span> <span class="s1">'premium_mob'</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiummob'</span>
    <span class="k">return</span> <span class="s1">'premium_plus'</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiumplus'</span>
    <span class="s1">'premium'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">send_acknowledgement_email</span>
    <span class="no">Mailer</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">acknowledgement_email_template</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:stripeEmail</span><span class="p">]).</span><span class="nf">deliver_now</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">acknowledgement_email_template</span>
    <span class="s2">"send_</span><span class="si">#{</span><span class="n">plan_name</span><span class="si">}</span><span class="s2">_payment_complete"</span><span class="p">.</span><span class="nf">to_sym</span>
  <span class="k">end</span>
</code></pre>
<p>There were certainly opportunities for refactoring, but I ignored them and pushed on to get the acceptance green.  I was a little disturbed that my creation of a new class <code>PremiumMob</code> was not throwing an error.  I turned aside to create specs for that:</p>
<pre class="highlight plaintext"><code>describe PremiumMob, type: :model do
  let(:type) { 'PremiumMob' }
  it_behaves_like 'a subscription'
end
</code></pre>
<p>And knowing that implementing the next end point would highlight the places for refactoring I did the same as above for the PremiumF2F plan.  I now had the two key endpoints that I wanted, and I could refactor with some security.  I actually started the refactoring in the cucumber steps (see the PR for details) and held off against using the Scenario Outline as the RubyMine automated refactoring was failing and I had 20 minutes left.  The cucumber steps were cleaner and I focused my attention on the charges controller.  I was feeling uncomfortable about these <code>plan_name</code> and <code>plan_class</code> methods that were effectively case statements.  I needed to keep <code>plan_name</code> as it was doing a not easily automatable mapping from the ids of the plans in the Stripe side to the snake_case versions in use on the Rails side:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">plan_name</span>
    <span class="k">return</span> <span class="s1">'premium_mob'</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiummob'</span>
    <span class="k">return</span> <span class="s1">'premium_f2f'</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiumf2f'</span>
    <span class="k">return</span> <span class="s1">'premium_plus'</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiumplus'</span>
    <span class="s1">'premium'</span>
  <span class="k">end</span>
</code></pre>
<p>Looking at this now I see I can refactor this further by replacing it with a hash data structure, but yesterday I used it to DRY out the <code>new</code> action:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">new</span>
    <span class="n">render</span> <span class="n">plan_name</span>
  <span class="k">end</span>
</code></pre>
<p>and the <code>plan_class</code> method:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">plan_class</span>
    <span class="k">return</span> <span class="no">PremiumF2F</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'premiumf2f'</span>
    <span class="n">plan_name</span><span class="p">.</span><span class="nf">camelcase</span><span class="p">.</span><span class="nf">constantize</span>
  <span class="k">end</span>
</code></pre>
<p>Note that there&rsquo;s an exceptional case in the above to handle some Rails Inflector screwiness that comes from the number 2 in the <code>PremiumF2F</code> class, which itself has to sit in a file named <code>premium_f2_f.rb</code> file to be auto-loaded.  I think I need all the different subscription types (<code>Premium</code>, <code>PremiumF2F</code>, <code>PremiumPlus</code>) to sit in their own module to avoid the funky file name.  Not sure if that will remove the exceptional case from <code>plan_class</code>.  I was out of time, but the tests were green and I&rsquo;d DRYed out some of the nastiest dampness from the charges controller.  Lots more to get done, but aside from code navel gazing, the key thing here is whether the new endpoints would generate any revenue.  In a quick mental calculation I worked out we would need 10 F2F sign ups, 20 Mob sign ups and another 40 premiums to make AgileVentures truly stable. Wonder if we can do that before Xmas?  That really would be an awesome Yuletide gift!  </p>

<p>Even if we don&rsquo;t, I&rsquo;ve highlighted a core insight for myself about an old truth.  Red, Green and THEN refactor :-) Looking back over the years there&rsquo;s so much trouble that&rsquo;s come from refactoring too early.  Maybe leave the refactoring till the acceptance test is green, not every time a unit test passes.  Let the code expand first, and then contract when it&rsquo;s green and try not to build in too much genericism.  Or at least I&rsquo;m saying that because the PR build is green - we&rsquo;ll see what happens when we deploy &hellip;</p>

<h3>Related Videos</h3>

<ul>
<li><a href="https://www.youtube.com/watch?v=1QPgTuAkzUE">&ldquo;Kent Beck&rdquo; Scrum</a></li>
<li><a href="https://www.youtube.com/watch?v=I8njkwFwTRc">&ldquo;Martin Fowler&rdquo; Scrum</a></li>
</ul>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK.</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
