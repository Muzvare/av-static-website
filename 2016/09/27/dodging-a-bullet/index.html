<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Dodging a Bullet</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2016 x2016_09 x2016_09_27 x2016_09_27_dodging-a-bullet x2016_09_27_dodging-a-bullet_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2016/09/27/dodging-a-bullet/">Dodging a Bullet</a></h2>
        <h5 class='date'>27 Sep 2016</h5>
    <p>So Monday was the day to see if our new domain model components would ease the process of delivering a new feature. As warm up I did a quick refactoring on our Karma calculation changes that Raoul had requested.  There was the possibility of re-using some cucumber steps.  We&rsquo;d submitted the following:</p>
<pre class="highlight ruby"><code><span class="no">When</span><span class="p">(</span><span class="sr">/^I run rake task "([^"]*)"$/</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
  <span class="vg">$rake</span><span class="p">[</span><span class="n">task</span><span class="p">].</span><span class="nf">invoke</span>    
<span class="k">end</span>

<span class="no">When</span><span class="p">(</span><span class="sr">/^I run the rake task for calculating karma points$/</span><span class="p">)</span> <span class="k">do</span>
  <span class="vg">$rake</span><span class="p">[</span><span class="s2">"karma_calculator"</span><span class="p">].</span><span class="nf">execute</span>
<span class="k">end</span>
</code></pre>
<p>and Raoul was suggesting re-using the the first step.  Looking it over I actually modified it to the following:</p>
<pre class="highlight ruby"><code><span class="no">When</span><span class="p">(</span><span class="sr">/^I run the rake task for calculating karma points$/</span><span class="p">)</span> <span class="k">do</span>
  <span class="vg">$rake</span><span class="p">[</span><span class="s2">"karma_calculator"</span><span class="p">].</span><span class="nf">execute</span>
<span class="k">end</span>

<span class="no">When</span><span class="p">(</span><span class="sr">/^I run the rake task for fetching github commits$/</span><span class="p">)</span> <span class="k">do</span>
  <span class="vg">$rake</span><span class="p">[</span><span class="s2">"fetch_github_commits"</span><span class="p">].</span><span class="nf">execute</span>
<span class="k">end</span>
</code></pre>
<p>Following the idea that the high level cucumber scenarios should be as readable English as possible, preferring <code>When I run the rake task for calculating karma points</code> to <code>When I run the rake task for &quot;karma_calculator&quot;</code>.  Trivial?  Maybe.  I&rsquo;m conflicted.  These are related to cucumber stories we have in our dev-ops section which I&rsquo;m hoping provides some testable documentation of the operational aspect of the application that&rsquo;s used by app admins rather than end users.  I&rsquo;m also going with not re-using step-definitions within step-definitions.  Two more heuristics there to add to the list.</p>

<p>I mention this warm up partly because I feel like there&rsquo;s a need to clean up the Cucumber stories we wrote on Monday.  As it happens, Raoul approved the above change and merged the new Karma calculation PR in, making it possible for us to get started on that refactoring work.  However I held off, preferring to go back to the Cucumber scenarios that defined our Monday&rsquo;s work:</p>
<pre class="highlight gherkin"><code>  <span class="kn">Scenario</span><span class="p">:</span> User is on free tier and looking at own page
    <span class="nf">Given</span> I am logged in
    <span class="nf">And</span> I am on my profile page
    <span class="nf">Then</span> I should see <span class="s">"Basic Member"</span>
    <span class="nf">And</span> I should not see <span class="s">"Premium Member"</span>

  <span class="kn">Scenario</span><span class="p">:</span> User is on free tier and looking at other persons profile page
    <span class="nf">Given</span> I am logged in
    <span class="nf">And</span> I visit Alice's profile page
    <span class="nf">Then</span> I should not see <span class="s">"Basic Member"</span>
    <span class="nf">And</span> I should not see <span class="s">"Premium Member"</span>
    <span class="nf">And</span> I should not see <span class="s">"Upgrade to Premium"</span>

  <span class="kn">Scenario</span><span class="p">:</span> User upgrades to premium from free tier
    <span class="nf">Given</span> I am logged in
    <span class="nf">And</span> I am on my profile page
    <span class="nf">And</span> I click <span class="s">"Upgrade to Premium"</span>
    <span class="nf">When</span> I fill in appropriate card details for premium
    <span class="nf">Then</span> I should see <span class="s">"Premium Member"</span>
    <span class="nf">Given</span> I am on my profile page
    <span class="nf">Then</span> I should not see <span class="s">"Basic Member"</span>
    <span class="nf">And</span> I should not see <span class="s">"Upgrade to Premium"</span>
</code></pre>
<p>We didn&rsquo;t get to these all at once.  We&rsquo;d put the fruits of our InsideOut work aside (the new domain elements Subscription and PaymentSource) and reverted to OutsideIn.  This was the set of experiences we wanted for the end user, in association with the <a href="https://github.com/AgileVentures/WebsiteOne/issues/1261">ticket</a> we were working on. We&rsquo;d actually started with two scenarios, one about upgrade to Premium and the other about upgrade to Premium Plus, and in my mind had been the idea that we would ultimately make both types of upgrade work using our new domain entities.</p>

<p>However that was actually scope creep off the ticket, and in fact there was a chunk of work specific to the ticket (upgrade from basic to Premium) that could be implemented in the existing system without any reference to the new domain entities, so we got that done.  It was mainly a change to the view to add a report about the user&rsquo;s current membership status, and an upgrade button:</p>
<pre class="highlight html"><code>    <span class="err">&lt;</span>% if current_user <span class="err">&amp;&amp;</span> current_user == presenter.user %&gt;
        <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= current_user.membership_type %&gt; Member<span class="nt">&lt;/li&gt;</span>
        <span class="err">&lt;</span>% unless current_user.membership_type == 'Premium' %&gt;
            <span class="nt">&lt;li&gt;</span><span class="err">&lt;</span>%= form_tag charges_path(plan: 'premium') do %&gt;
                  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://checkout.stripe.com/checkout.js"</span> <span class="na">class=</span><span class="s">"stripe-button"</span>
                          <span class="na">data-key=</span><span class="s">"&lt;%= Rails.configuration.stripe[:publishable_key] %&gt;"</span>
                          <span class="na">data-description=</span><span class="s">"A month's subscription"</span>
                          <span class="na">data-amount=</span><span class="s">"1000"</span>
                          <span class="na">data-currency=</span><span class="s">"GBP"</span>
                          <span class="na">data-locale=</span><span class="s">"en-US"</span>
                          <span class="na">data-name=</span><span class="s">"Premium Membership"</span>
                          <span class="na">data-label=</span><span class="s">"Upgrade to Premium"</span><span class="nt">&gt;&lt;/script&gt;</span>

              <span class="err">&lt;</span>% end %&gt;
            <span class="nt">&lt;/li&gt;</span>
        <span class="err">&lt;</span>% end %&gt;
    <span class="err">&lt;</span>% end %&gt;  
</code></pre>
<p>I&rsquo;m itching to pull this into a partial (<a href="https://github.com/AgileVentures/WebsiteOne/issues/1306">refactoring ticket</a>), and I also worry we&rsquo;re not being confident enough with our logic - of which there is also too much in the view.  Devise&rsquo;s <code>current_user</code> method is maybe the source of our timidity, since if no one is logged in, it returns nil.  Perhaps it would be better if it returned an AnonymousUser object.  Michael started looking into how we might override it, but I demurred, writing an email to Stripe about our new approach of locking the data-locale to &ldquo;en-US&rdquo;.  All that was actually after we&rsquo;d dropped to the RSpec level to create the necessary supporting operations for the view fragment above.  Let&rsquo;s just take a look at them:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'#membership_type'</span> <span class="k">do</span>

    <span class="n">subject</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">'returns membership type'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">membership_type</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s1">'Basic'</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'premium member'</span> <span class="k">do</span>

      <span class="n">subject</span><span class="p">(</span><span class="ss">:user</span><span class="p">){</span><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">stripe_customer: </span><span class="s2">"sdfdfds"</span><span class="p">)}</span>

      <span class="n">it</span> <span class="s1">'returns premium'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">membership_type</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s1">'Premium'</span>
      <span class="k">end</span>

    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">do</span>
</code></pre><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">def</span> <span class="n">membership_type</span>
    <span class="k">return</span> <span class="s2">"Basic"</span> <span class="k">unless</span> <span class="n">stripe_customer</span>
    <span class="s2">"Premium"</span>
  <span class="k">end</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
<p>and finally a little addition to the charges controller, so that when users sign up for premium their customer id is stored in the user table:</p>
<pre class="highlight ruby"><code>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@plan</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:plan</span><span class="p">]</span>

    <span class="n">customer</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Customer</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
        <span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:stripeEmail</span><span class="p">],</span>
        <span class="ss">source: </span><span class="n">params</span><span class="p">[</span><span class="ss">:stripeToken</span><span class="p">],</span>
        <span class="ss">plan: </span><span class="vi">@plan</span>
    <span class="p">)</span>

    <span class="n">update_user_to_premium</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>

    <span class="n">send_acknowledgement_email</span>

  <span class="k">rescue</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">CardError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:error</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
    <span class="n">redirect_to</span> <span class="n">new_charge_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">update_user_to_premium</span><span class="p">(</span><span class="n">stripe_customer</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="n">current_user</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">stripe_customer</span> <span class="o">=</span> <span class="n">stripe_customer</span><span class="p">.</span><span class="nf">id</span>
    <span class="n">current_user</span><span class="p">.</span><span class="nf">save</span>
  <span class="k">end</span>
</code></pre>
<p>The upshot of which was that using only the existing aspects of the system the Premium users would see their status on their profile page, and other users would see the upgrade button.  It was all working without the aid of the new domain entities.  As I mentioned above, Michael and I had other concerns with our implementation, but with my eye on the clock I suggested we get this in as a pull request, and then use the new domain entities to support work on a subsequent <a href="https://github.com/AgileVentures/WebsiteOne/issues/1303">ticket of allowing premium users to upgrade to premium plus</a>.</p>

<p>I had other conflicts dripping out of me, such as whether we should be testing Stripe differently (Webmock?) and whether we should be making our scenarios more declarative.  I guess part of the challenge with our increasing list of heuristics for good coding and good project management is that it can feel like you are being pulled in multiple directions at once, and you can be forgiven for a kind of paranoia about which really is the most important issue to work on first.</p>

<p>Submitting the PR for just the above code involved pulling out the commits for the new domain model entities.  One thing that was easy to prioritise for me was to put only the smallest set of necessary elements in the pull request.  I didn&rsquo;t want Raoul&rsquo;s to get distracted during his code review by having a set of un-used domain entities in the incoming code.  Michael found a <a href="http://stackoverflow.com/a/1994491/316729">cool technique for cherry picking a set of commits</a> and we got in a PR with just the code above, and moved the domain entities onto a new branch associated with the ticket for creating the premium plus upgrade button.  Will we fall foul of premature refactoring?  Or did we just dodge a bullet?</p>

<p>It&rsquo;s pretty clear to me that the current <code>stripe_customer</code> field on user can&rsquo;t support information about different membership plans.  Hopefully our InsideOut work will bear fruit in the next session!  Would it be too much to hope that we&rsquo;ll have dodged one bullet and be ready to unleash some of our own? :-)</p>

<p>Related Videos:</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=UprAXzePQmo">Pairing on the above</a></li>
<li><a href="https://www.youtube.com/watch?v=JPvkCffsHOo">&ldquo;Kent Beck&rdquo; scrum</a></li>
</ul>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
