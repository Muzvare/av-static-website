<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Frustratingly Slow Debug Cycle</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2016 x2016_11 x2016_11_03 x2016_11_03_frustratingly-slow-debug-cycle x2016_11_03_frustratingly-slow-debug-cycle_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2016/11/03/frustratingly-slow-debug-cycle/">Frustratingly Slow Debug Cycle</a></h2>
        <h5 class='date'> 3 Nov 2016</h5>
    <p>Michael had lots of great ideas about tracking people through the site today, but I wanted to quickly push out the &ldquo;sponsor other users&rdquo; feature.  I was following the logic from Monday, where dashing out a PayPal endpoint had opened up some payment streams.  I had one person waiting to use the sponsor others, and I was promising myself a phase of consolidation once that was done.  In fairly short order we stamped out some cucumber scenarios:</p>
<pre class="highlight gherkin"><code><span class="kd">Feature</span><span class="p">:</span> Allow Users to Sponsor other members
  As a user
  So that I can help someone else get premium services
  I would like to be able to pay for their premium service

  <span class="kn">Background</span><span class="p">:</span>
    <span class="nf">Given</span> the following users exist
      <span class="p">|</span> <span class="nv">first_name</span> <span class="p">|</span> <span class="nv">last_name</span> <span class="p">|</span> <span class="nv">email</span>                  <span class="p">|</span> <span class="nv">github_profile_url</span>         <span class="p">|</span> <span class="nv">last_sign_in_ip</span> <span class="p">|</span>
      <span class="p">|</span> <span class="n">Alice</span>      <span class="p">|</span> <span class="n">Jones</span>     <span class="p">|</span> <span class="n">alice@btinternet.co.uk</span> <span class="p">|</span> <span class="n">http://github.com/AliceSky</span> <span class="p">|</span> <span class="n">127.0.0.1</span>       <span class="p">|</span>

  <span class="kn">Scenario</span><span class="p">:</span> User upgrades another user from free tier to premium
    <span class="nf">Given</span> I am logged in
    <span class="nf">And</span> I visit Alice's profile page
    <span class="nf">And</span> I click <span class="s">"Sponsor for Premium"</span>
    <span class="nf">When</span> I fill in appropriate card details for premium
    <span class="nf">Then</span> I should see <span class="s">"you have sponsored Alice Jones as a Premium Member"</span>
    <span class="nf">Given</span> I visit Alice's profile page
    <span class="nf">Then</span> I should see <span class="s">"Premium Member"</span>
    <span class="nf">Then</span> I should not see <span class="s">"Basic Member"</span>
    <span class="nf">Then</span> I should not see <span class="s">"Sponsor for Premium"</span>
    <span class="nf">And</span> I should not see <span class="s">"Upgrade to Premium"</span>

  <span class="kn">Scenario</span><span class="p">:</span> non logged in user upgrades another user from free tier to premium
    <span class="nf">Given</span> I visit Alice's profile page
    <span class="nf">And</span> I click <span class="s">"Sponsor for Premium"</span>
    <span class="nf">When</span> I fill in appropriate card details for premium
    <span class="nf">Then</span> I should see <span class="s">"you have sponsored Alice Jones as a Premium Member"</span>
    <span class="nf">Given</span> I visit Alice's profile page
    <span class="nf">Then</span> I should see <span class="s">"Premium Member"</span>
    <span class="nf">Then</span> I should not see <span class="s">"Basic Member"</span>
    <span class="nf">Then</span> I should not see <span class="s">"Sponsor for Premium"</span>
    <span class="nf">And</span> I should not see <span class="s">"Upgrade to Premium"</span>
</code></pre>
<p>which could be more declarative, but they were good enough for now.  We then stamped out some even messier code to get them green.  This was all me.  I was following my &ldquo;get it green, THEN refactor&rdquo; mantra of the previous week.  Just to show you how messy some things were, take a look at this view:</p>
<pre class="highlight html"><code><span class="err">&lt;</span>% if @user.present? <span class="err">&amp;&amp;</span> current_user != @user %&gt;
    <span class="err">&lt;</span>% if @plan == 'premium' %&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you have sponsored <span class="err">&lt;</span>%= @user.display_name %&gt; as a Premium Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>You're seven day free trial has now started.  Your card will not be charged until seven days have passed.<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% elsif @plan == 'premiummob'%&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you have sponsored <span class="err">&lt;</span>%= @user.display_name %&gt; as a Premium MOB Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium mob membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% elsif @plan == 'premiumf2f'%&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you have sponsored <span class="err">&lt;</span>%= @user.display_name %&gt; as a Premium F2F Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium f2f membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% else %&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you have sponsored <span class="err">&lt;</span>%= @user.display_name %&gt; as a Premium PLUS Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium plus membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% end %&gt;
<span class="err">&lt;</span>% else %&gt;
    <span class="err">&lt;</span>% if @plan == 'premium' %&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you're now an AgileVentures Premium Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>You're seven day free trial has now started.  Your card will not be charged until seven days have passed.<span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% elsif @plan == 'premiummob'%&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you're now an AgileVentures Premium MOB Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium mob membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% elsif @plan == 'premiumf2f'%&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you're now an AgileVentures Premium F2F Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium f2f membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% else %&gt;
        <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">'payment_complete'</span><span class="nt">&gt;</span>Thanks, you're now an AgileVentures Premium PLUS Member!<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>An AgileVentures mentor will be in touch shortly to help you receive all of your premium plus membership benefits.<span class="nt">&lt;/p&gt;</span>
    <span class="err">&lt;</span>% end %&gt;
<span class="err">&lt;</span>% end %&gt;
</code></pre>
<p>Ugh, business logic in the view, lots to DRY out, and now I look at it again, some mistakes in wording.  However, all those changes would be fairly easy to make.  The danger is that we don&rsquo;t get to them.  Michael and I went to the &ldquo;Kent Beck&rdquo; scrum and changed roles.  The cukes that had been green for me were now failing for Michael, failing on CI, and failing when I pulled them back onto my machine.</p>

<p>It seemed the full set of Premium related features was failing when run in full batch mode (Stripe iFrame not appearing), but would work when run individually, or from a set in their own folder (i.e. <code>cucumber features/premium/*</code>).  Michael was then also getting individual failures related to a re-used Stripe token.  We were in a bit of a mess and burnt the best part of an hour investigating.  More importantly we weren&rsquo;t doing any refactoring of the messy app code!</p>

<p>The functionality was working when we run the site manually.  So frustrating.  Trying to push out something to receive some money, that works manually, but the feature tests don&rsquo;t pass due to some odd bug, which turns into a massive time sink.  I wanted to start trying the <a href="https://github.com/rebelidealist/stripe-ruby-mock">stripe-ruby-mock</a> which the CraftAcademy folks had had some success with.  It was not necessarily a snap fix, but I was starting to really hate all the many fixture files that came with sandboxing complex network interactions.  Occasional cache leaks would mean that developers would suddenly find a load of extra files on their file system.  Pull requests for new features would have 112 instead of 12 changed files.  Maybe the PR display on GitHub could be adapted to handle that, but I was really starting to feel this was all more trouble than it was worth.</p>

<p>Michael was keen to understand these errors and these tests.  We got down into the PuffingBilly config where I remembered there was this additional step to ignore params on a unique URL that Stripe interactions generated.  I got the tests green again, but then they still failed in batch.  Also, Stripe had told us that they were happy with a load on their test servers that was &ldquo;within reason&rdquo;.  So this morning I tried taking the VCR and PuffingBilly caches off the tests, which would make our tests sensitive to network failures, just to see if that could get things passing in batch; but that still fails.  The test needs JavaScript and I think we have puffing billy hardwired in to all JS tests at the moment.  I could remove that and maybe I could get all the tests passing, but then again &hellip;</p>

<p>One of the biggest issues here is the slow debug cycle.  If the failures only occur in full batch then we have to run the entire cucumber suite, which takes ten minutes.  That might not seem like a lot, but it burns up time.  I&rsquo;ve always seen that as a real red flag.  Being stuck with a slow debug cycle is asking for trouble.  Do anything you can to reduce the amount of time before you get feedback on whether a change you make is working or not!  I think the next thing to try is to create a @no-billy tag to opt out these scenarios from headless browser javascript caching to see if that will pass.  Other options include the stripe-ruby-mock gem, or just not having tests on the payment portions, which I&rsquo;ve heard some people advocate.  Fingers crossed for a less frustrating session today &hellip;</p>

<h3>Related Videos</h3>

<ul>
<li><a href="https://www.youtube.com/watch?v=boCPUJ3sdlE">Pairing on WebSiteOne, part 1</a></li>
<li><a href="https://www.youtube.com/watch?v=20ZeJ9FcOxA">&ldquo;Kent Beck&rdquo; Scrum</a></li>
<li><a href="https://www.youtube.com/watch?v=eAdPTF5A5O8">Pairing on WebSiteOne part 2</a></li>
</ul>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
