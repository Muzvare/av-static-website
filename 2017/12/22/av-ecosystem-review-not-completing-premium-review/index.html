<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>AV EcoSystem Review Not Completing Premium Review</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2017 x2017_12 x2017_12_22 x2017_12_22_av-ecosystem-review-not-completing-premium-review x2017_12_22_av-ecosystem-review-not-completing-premium-review_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2017/12/22/av-ecosystem-review-not-completing-premium-review/">AV EcoSystem Review Not Completing Premium Review</a></h2>
        <h5 class='date'>22 Dec 2017</h5>
    <p><img alt="not completing" src="/images/not-completing.jpg" /></p>

<p>So I reckon I&rsquo;ve spent about 40 minutes each morning this week working through Premium members.  I think I&rsquo;ve reviewed 20 and, where possible, got their data updated and correct in the WSO system so that we have a &ldquo;single source of truth&rdquo; for data about Premium members, and that it can be exposed over the secure Premium API for use by the machine learning system.  Of course we&rsquo;re throwing up various changes that are needed in the data model and there&rsquo;s going to need to be more hooking up to the Slack and Paypal APIs in order to ensure that changes to Premium statuses can be coordinated directly through the WSO site, both by admins and by the individual members themselves.  I&rsquo;ll forge on this morning.  The latest is an orphaned subscription:</p>
<pre class="highlight json"><code><span class="w">  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nt">"sponsor_email"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nt">"started_on"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-02-28"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"ended_on"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nt">"plan_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Premium Mob"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"payment_source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PaymentSource::Stripe"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Matching up the timings I can see that this is an orphaned subscription created when a Premium Mob member upgraded to Premium F2F.  I won&rsquo;t be able to clear this up until we have a different relation in the database model.  I wonder if that&rsquo;s the thing to start on.  I find a relevant ticket in the waffle board and check out a branch for that and then change the relation between users and subscriptions to a <code>has_many</code>:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_many</span> <span class="ss">:subscription</span><span class="p">,</span> <span class="ss">autosave: </span><span class="kp">true</span>
</code></pre>
<p>That creates a series of failures in the specs where attempts to get <code>user.subscription.plan</code> are not working because we would now have to talk about <code>user.subscriptions</code>.  I guess we should replace <code>user.subscription</code> with something like <code>user.current_subscription</code> where we&rsquo;d find the user&rsquo;s subscription that didn&rsquo;t have an <code>ended_at</code> date.  We&rsquo;d also need to ensure that the user only had one active subscription at a time.  So various changes, and I could dive into those, but maybe making the connection to as many Premium members as possible is the key thing &hellip;</p>

<p>I&rsquo;m caught for a moment about whether I should try and update the <code>ended_at</code> date for the old Premium Mob subscription for the member who upgraded to F2F, which I decided to do for consistency:</p>
<pre class="highlight plaintext"><code>irb(main):002:0&gt; pp Subscription.all.select{|s| s.user.nil?} ; nil
[#&lt;Subscription:0x007faf45ddd0c8
  id: 40,
  type: nil,
  started_at: Tue, 28 Feb 2017 02:00:22 UTC +00:00,
  ended_at: nil,
  user_id: nil,
  plan_id: 2,
  sponsor_id: nil&gt;,
 #&lt;PremiumF2F:0x007faf3f729b60
  id: 32,
  type: "PremiumF2F",
  started_at: Tue, 03 Jan 2017 18:00:24 UTC +00:00,
  ended_at: nil,
  user_id: nil,
  plan_id: 3,
  sponsor_id: nil&gt;,
 #&lt;Premium:0x007faf3f729930
  id: 3,
  type: "Premium",
  started_at: Tue, 25 Oct 2016 16:46:56 UTC +00:00,
  ended_at: nil,
  user_id: nil,
  plan_id: 1,
  sponsor_id: nil&gt;,
 #&lt;Subscription:0x007faf3f7288a0
  id: 58,
  type: nil,
  started_at: Thu, 10 Nov 2016 11:11:00 UTC +00:00,
  ended_at: nil,
  user_id: nil,
  plan_id: 1,
  sponsor_id: nil&gt;,
 #&lt;Subscription:0x007faf45deff20
  id: 46,
  type: nil,
  started_at: Wed, 03 May 2017 18:47:13 UTC +00:00,
  ended_at: nil,
  user_id: nil,
  plan_id: 2,
  sponsor_id: nil&gt;,
 #&lt;Subscription:0x007faf45def8b8
  id: 44,
  type: nil,
  started_at: Tue, 25 Apr 2017 08:41:15 UTC +00:00,
  ended_at: nil,
  user_id: nil,
  plan_id: 1,
  sponsor_id: nil&gt;]
irb(main):003:0&gt; s = Subscription.find(40)
=&gt; #&lt;Subscription id: 40, type: nil, started_at: "2017-02-28 02:00:22", ended_at: nil, user_id: nil, plan_id: 2, sponsor_id: nil&gt;
irb(main):004:0&gt; u = User.find_by email: '...'
irb(main):005:0&gt; u.subscription.started_at
=&gt; Fri, 14 Jul 2017 01:17:42 UTC +00:00
irb(main):006:0&gt; s.ended_at = u.subscription.started_at
=&gt; Fri, 14 Jul 2017 01:17:42 UTC +00:00
irb(main):007:0&gt; s.save
</code></pre>
<p>Next up I have a member who got three months of Premium from CraftAcademy South Africa, but they are in the system as paying via Stripe since that&rsquo;s how CA SA paid.  The member is now paying their own way (also over Stripe), and again we need support for multiple subscriptions per user to update that.  The next member is also a CraftAcademy South Africa graduate who is paying their own way, and subsequently upgraded to Premium Mob.  Again, I won&rsquo;t be able to fix these up without the domain model changes.  I guess I push on and fix up what I can and then take another pass once I get the domain model fix out.</p>

<p>I note what I&rsquo;m not doing recently is remembering to work with Mob level members on their professional development plans &hellip; although I don&rsquo;t know how much folks really appreciate that.  It&rsquo;s kind of a challenging thing for busy people to keep up with &hellip;</p>

<p>I think that&rsquo;s last one for today now.  A Premium Plus member who downgraded to Premium F2F and that all needs to be represented to.  That domain model &hellip;</p>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
