<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>AV EcoSystem Review Inspecting Gems</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2017 x2017_09 x2017_09_18 x2017_09_18_av-ecosystem-review-inspecting-gems x2017_09_18_av-ecosystem-review-inspecting-gems_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2017/09/18/av-ecosystem-review-inspecting-gems/">AV EcoSystem Review Inspecting Gems</a></h2>
        <h5 class='date'>18 Sep 2017</h5>
    <p><img alt="gems" src="/images/gems.jpg" /></p>

<p>So my AV ecosystem reviews are getting further afield.  Here I am inspecting different gems for the purpose of completing a feature to support multiple project repositories.  What are the goals of this ongoing review? It&rsquo;s to focus my blogging power onto making the AV ecosystem as welcoming and easy to use as possible.  That&rsquo;s the flow of people from external sources to our website, to our Slack instance and to contributing to the projects we have hosted on GitHub.  This feature is a response to a request from a project maintainer, and that&rsquo;s a stakeholder that we might have overlooked, so I&rsquo;ll see what giving them focus can do.</p>

<p>Last Friday after spiking an interface component for dynamic form fields in rails, I found some gems that might provide a more coherent approach.  <a href="https://github.com/ncri/nested_form_fields">https://github.com/ncri/nested<em>form</em>fields</a> is my current lead candidate.  243 stars suggests it has some popularity and I can see that it was updated as recently as five days ago.  There&rsquo;s also <a href="https://github.com/ryanb/nested_form">https://github.com/ryanb/nested_form</a> with 1,769 stars, but hasn&rsquo;t been updated in 4 years.  Another <a href="https://www.google.co.uk/search?q=gems+rails+nested+form">quick search</a> shows me there&rsquo;s also <a href="https://github.com/nathanvda/cocoon">https://github.com/nathanvda/cocoon</a> with 2,445 stars and was updated as recently as 3 days ago.  Glad I did that search, or I might not have found this other important contender which looks like the field leader at the moment.  Let&rsquo;s try it out - following the README instructions on how to install &hellip;</p>

<p>Using Cocoon requires the nested models that we haven&rsquo;t set up yet, and then has options for using Rails Formtastic, SimpleForm or Standard Rails forms.  I&rsquo;m tempted to go for standard Rails forms, since I don&rsquo;t want to take on too much at once.  I&rsquo;ll start with the migration, I guess, to pull the github_url out of the project and into a separate table &hellip;</p>
<pre class="highlight shell"><code><span class="o">[</span>tansaku@Samuels-MBP:~/Documents/Github/AgileVentures/WebsiteOne <span class="o">(</span>761_multiple_source_repository<span class="o">)]</span><span class="nv">$ </span>
â†’ rails g model SourceRepository url:string
      invoke  active_record
      create    db/migrate/20170918083218_create_source_repositories.rb
      create    app/models/source_repository.rb
      invoke    rspec
      create      spec/models/source_repository_spec.rb
      invoke      factory_girl
      create        spec/factories/source_repositories.rb
</code></pre>
<p>I can then edit the created model to have the setup that Cocoon requires:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">SourceRepository</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:project</span>
<span class="k">end</span>
</code></pre>
<p>and refer to it in the existing Project class:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>

  <span class="nf">has_many</span> <span class="ss">:source_repositories</span><span class="p">,</span> <span class="n">inverse_of</span> <span class="ss">:project</span>
  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:source_repositories</span><span class="p">,</span> <span class="ss">reject_if: :all_blank</span><span class="p">,</span> <span class="ss">allow_destroy: </span><span class="kp">true</span>
</code></pre>
<p>Using an online HAML to ERB converter I can get the project example forms in ERB, and adjust to our needs:</p>
<pre class="highlight erb"><code><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@project</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;br/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:description</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;br/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:description</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;h3&gt;</span>Source Repositories<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"source_repositories"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">fields_for</span> <span class="ss">:source_repositories</span> <span class="k">do</span> <span class="o">|</span><span class="n">source_repository</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'source_repository_fields'</span><span class="p">,</span> <span class="ss">f: </span><span class="n">source_repository</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"links"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to_add_association</span> <span class="s1">'add source_repository'</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="ss">:source_repositories</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<p>and the partial:</p>
<pre class="highlight erb"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"nested-fields"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:url</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;br/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:url</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to_remove_association</span> <span class="s2">"remove source repository"</span><span class="p">,</span> <span class="n">f</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
<p>and after a few misteps back and forth to add the correct references to the model/migration:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">CreateSourceRepositories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:source_repositories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:url</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:url</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:project</span> <span class="c1"># &lt;-- needed this</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>I was rewarded with seeing the boiler plate form allowing me to both add and remove source repositories:</p>

<p><img src="https://dl.dropbox.com/s/vy7u9shkciiljc7/Screenshot%202017-09-18%2009.53.22.png?dl=1" /></p>

<p>Hopefully a bit of cleanup and formatting and this will look nice and have more functionality that I was able to immediately hand-roll.  I could probably have implemented dynamic removal of form fields in the same time it took me to get proof of concept on this gem.  However using this gem will hopefully make our system less suprising to new developers who might have seen this gem on other projects, and we&rsquo;ll potentially get the benefits of upgrades and fixes to the gem itself.</p>

<p>Of course, despite getting the interface working, the repository data that I inputted was not actually saved to the database as such, but then I hadn&rsquo;t got that part working in my own hand-rolled version either :-)</p>

<p>I can see the data being passed back:</p>
<pre class="highlight plaintext"><code>Started POST "/projects" for ::1 at 2017-09-18 08:56:32 +0000
Processing by ProjectsController#create as HTML
  Parameters: {"utf8"=&gt;"âœ“", "authenticity_token"=&gt;"0/yym9qPkJcAgoxhJqfg2UIOfDEFIDda2qW2VWZCVl2AF0/fytCniCb8bJb/qy1ZV0f/CXYDc9mvGBElB51A4g==", "project"=&gt;{"title"=&gt;"test", "image_url"=&gt;"", "description"=&gt;"test", "status"=&gt;"Active", "github_url"=&gt;"", "source_repositories_attributes"=&gt;{"1505724773160"=&gt;{"url"=&gt;"test", "_destroy"=&gt;"false"}, "1505724775431"=&gt;{"url"=&gt;"test2", "_destroy"=&gt;"false"}, "1505724776802"=&gt;{"url"=&gt;"test3", "_destroy"=&gt;"false"}}, "pivotaltracker_url"=&gt;""}, "commit"=&gt;"Submit"}
  User Load (0.6ms)  SELECT  "users".* FROM "users" WHERE "users"."deleted_at" IS NULL AND "users"."id" = $1  ORDER BY "users"."id" ASC LIMIT 1  [["id", 3]]
  Event Load (1.5ms)  SELECT "events".* FROM "events" WHERE "events"."category" = $1  [["category", "Scrum"]]
Unpermitted parameter: source_repositories_attributes
   (0.2ms)  BEGIN
  Project Exists (2.8ms)  SELECT  1 AS one FROM "projects" WHERE ("projects"."id" IS NOT NULL) AND "projects"."slug" = 'test' LIMIT 1
  SQL (4.6ms)  INSERT INTO "projects" ("title", "description", "status", "github_url", "pivotaltracker_url", "image_url", "user_id", "slug", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING "id"  [["title", "test"], ["description", "test"], ["status", "Active"], ["github_url", ""], ["pivotaltracker_url", ""], ["image_url", ""], ["user_id", 3], ["slug", "test-8018e213-701c-40bd-aa02-caa3025ae4ba"], ["created_at", "2017-09-18 08:56:33.028974"], ["updated_at", "2017-09-18 08:56:33.028974"]]
</code></pre>
<p>I was about to say that I&rsquo;d leave fixing that till tommorrow, but I had a quick idea it was to do with strong parameters, and it was:</p>
<pre class="highlight ruby"><code>  <span class="k">def</span> <span class="nf">project_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:project</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:pitch</span><span class="p">,</span> <span class="ss">:created</span><span class="p">,</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:github_url</span><span class="p">,</span> <span class="ss">:pivotaltracker_url</span><span class="p">,</span> <span class="ss">:pivotaltracker_id</span><span class="p">,</span> <span class="ss">:image_url</span><span class="p">,</span> <span class="ss">source_repositories_attributes: </span><span class="p">[</span><span class="ss">:url</span><span class="p">])</span>
  <span class="k">end</span>
</code></pre>
<p>We also needed to specify the nested required attributes, and now we are saving our new repo information to the database thanks to <a href="https://stackoverflow.com/questions/15919761/rails-4-nested-attributes-unpermitted-parameters">Stack Overflow</a>!</p>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
