<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Azure MediaWiki Stack Part 3</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2017 x2017_05 x2017_05_23 x2017_05_23_azure-mediawiki-stack-part3 x2017_05_23_azure-mediawiki-stack-part3_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2017/05/23/azure-mediawiki-stack-part3/">Azure MediaWiki Stack Part 3</a></h2>
        <h5 class='date'>23 May 2017</h5>
    <p><img alt="mediawiki" src="/images/MediaWiki.svg" /></p>

<p>Ahhh, so rebuilding the MediaWiki stack on Azure leaks over three days and I suspect it may be more.  Yesterday I got stuck trying to open a port for the VisualEditor and I suspect there will be other blocks, but that&rsquo;s why I&rsquo;m forcing myself through this to have it all documented so it&rsquo;s not a pain when we are really short on time.  I also got distracted playing with inkscape this morning, but that&rsquo;s another story.</p>

<p>I&rsquo;m not sure that I have time, but I couldn&rsquo;t help checking to see if removing the security rule in Azure would prevent the VisualEditor from working, and unless there&rsquo;s some kind of caching going on that I understand, it looks like the security rule really isn&rsquo;t necessary.  I certainly suspected that, since it isn&rsquo;t connected up to anything else in the system.  So in principle I can delete those security rules and that&rsquo;s one less thing to maintain and organise.  Confusing, because we definitely need security rules like that to work with AWS.  Presumably we&rsquo;d need them for some other kinds of configuration on Azure &hellip;</p>

<p>The next thing to set up is the SSL, which I remember as somewhat complicated AND there&rsquo;s making sure that the Visual Editor continues to work with the SSL on.  There&rsquo;s also the moderation component, the wikieditor, and the banner.  Also I&rsquo;d like to see if there&rsquo;s some way to run MediaWiki&rsquo;s cucumber tests</p>

<p>Although I see from the manual that we musn&rsquo;t run the unit tests on a production wiki: https://www.mediawiki.org/wiki/Manual:PHP<em>unit</em>testing/Running<em>the</em>unit<em>tests  Perhaps the browser testing is safer: https://www.mediawiki.org/wiki/Browser</em>testing but it looks like these might also make a mess of a production system.</p>

<p>Hmm, well maybe I go for the low hanging fruit first.  Let&rsquo;s install the WikiEditor in LocalSettings.php:</p>
<pre class="highlight php"><code>## Load WikiEditor

wfLoadExtension('WikiEditor');

# Enables use of WikiEditor by default but still allows users to disable it in preferences
$wgDefaultUserOptions['usebetatoolbar'] = 1;

# Enables link and table wizards by default but still allows users to disable them in preferences
$wgDefaultUserOptions['usebetatoolbar-cgd'] = 1;

# Displays the Preview and Changes tabs
$wgDefaultUserOptions['wikieditor-preview'] = 1;

# Displays the Publish and Cancel buttons on the top right side
$wgDefaultUserOptions['wikieditor-publish'] = 1;
</code></pre>
<p>and the Moderation extension:</p>
<pre class="highlight php"><code>## Moderation Extension

wfLoadExtension( 'Moderation' );

$wgGroupPermissions['sysop']['moderation'] = true; # Allow sysops to use Special:Moderation
$wgGroupPermissions['sysop']['skip-moderation'] = true; # Allow sysops to skip moderation
$wgGroupPermissions['bot']['skip-moderation'] = true; # Allow bots to skip moderation
$wgGroupPermissions['checkuser']['moderation-checkuser'] = false; # Don't let checkusers see IPs on Special:Moderation

$wgAddGroups['sysop'][] = 'automoderated'; # Allow sysops to assign "automoderated" flag
$wgRemoveGroups['sysop'][] = 'automoderated'; # Allow sysops to remove "automoderated" flag

$wgModerationNotificationEnable = true;
$wgModerationNotificationNewOnly = false;
$wgModerationEmail = $wgEmergencyContact;

</code></pre>
<p>which requires the code to be checked out of git into a <code>Moderation</code> directory in the <code>extensions</code> folder which also requires installing git:</p>
<pre class="highlight plaintext"><code>$ sudo apt-get install git
$ git clone https://github.com/edwardspec/mediawiki-moderation
</code></pre>
<p>All the instructions for that are <a href="https://www.mediawiki.org/wiki/Extension:Moderation#Installation">here</a> but note that we also need to ensure that the root git directory gets renamed from <code>mediawiki-moderation</code> to <code>Moderation</code>.  I can see that&rsquo;s all working as expected on IE11 and also that the maintainer of the Moderation extension has pushed my suggested change to the moderation banner into the master branch of the Moderation GitHub repo.</p>

<p>There&rsquo;s also the CSS to set up, so that we can have our banner throughout</p>
<pre class="highlight php"><code>## Allow Common.css to load on restricted pages 

$wgAllowSiteCSSOnRestrictedPages = true;

</code></pre>
<p>and then drop the following into the Mediawiki:Common.css page:</p>
<pre class="highlight css"><code><span class="c">/* CSS placed here will be applied to all skins */</span>

<span class="nf">#mw-head</span><span class="p">{</span>
    <span class="nl">margin-top</span><span class="p">:</span><span class="m">123px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.mw-wiki-logo</span><span class="p">{</span>
    <span class="nl">background-image</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#hlp-banner</span> <span class="p">{</span>
   <span class="c">/* background:url('https://www.dropbox.com/s/2yokso0fkd3bivt/Screenshot%202017-05-08%2010.40.18.png?dl=1'); */</span>
    <span class="nl">width</span><span class="p">:</span><span class="m">100%</span><span class="p">;</span>
    <span class="nl">min-height</span><span class="p">:</span><span class="m">123px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="p">{</span>
    <span class="nl">background</span><span class="p">:</span> <span class="m">#003992</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.content</span> <span class="p">{</span>
    <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.block-inner</span> <span class="p">{</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">max-width</span><span class="p">:</span> <span class="m">1200px</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">right</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.content</span><span class="nd">:before</span> <span class="p">{</span>
    <span class="nl">background</span><span class="p">:</span> <span class="sx">url(https://www.healthylondon.org/sites/all/themes/nhslondon/assets/img/hlp-people2.png)</span> <span class="nb">left</span> <span class="nb">bottom</span> <span class="nb">no-repeat</span><span class="p">;</span>
    <span class="nl">background-size</span><span class="p">:</span> <span class="m">135px</span> <span class="m">115px</span><span class="p">;</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.content</span><span class="nd">:after</span> <span class="p">{</span>
    <span class="nl">background</span><span class="p">:</span> <span class="sx">url(https://www.healthylondon.org/sites/all/themes/nhslondon/assets/img/hlp-people1.png)</span> <span class="nb">right</span> <span class="nb">bottom</span> <span class="nb">no-repeat</span><span class="p">;</span>
    <span class="nl">background-size</span><span class="p">:</span> <span class="m">130px</span> <span class="m">115px</span><span class="p">;</span>
    <span class="nl">float</span><span class="p">:</span> <span class="nb">right</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.content</span><span class="nd">:before</span><span class="o">,</span> <span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.content</span><span class="nd">:after</span> <span class="p">{</span>
    <span class="nl">content</span><span class="p">:</span> <span class="s2">''</span><span class="p">;</span>
    <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">120px</span><span class="p">;</span>
    <span class="nl">margin-top</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">140px</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">767px</span><span class="p">)</span> <span class="p">{</span> 
    <span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nt">img</span> <span class="p">{</span>
      <span class="nl">width</span><span class="p">:</span> <span class="m">220px</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">@media</span> <span class="p">(</span><span class="n">max-width</span><span class="p">:</span> <span class="m">767px</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.content</span><span class="nd">:after</span><span class="o">,</span> <span class="nf">#block-mhl-hlp-mhl-hlp-logo</span> <span class="nc">.content</span><span class="nd">:before</span> <span class="p">{</span>
        <span class="nl">display</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>If I recall I made some edits to the Vector template to get the HLP banner in there.  Here&rsquo;s the diff of before and after:</p>
<pre class="highlight plaintext"><code>97,106d96
&lt;       &lt;div id="hlp-banner"&gt;
&lt;                   &lt;div id="block-mhl-hlp-mhl-hlp-logo" class="block block-mhl-hlp"&gt;
&lt;                     &lt;div class="block-inner"&gt;
&lt;                       &lt;div class="content"&gt;
&lt;                         &lt;a href="https://www.healthylondon.org/" class=""&gt;&lt;img typeof="foaf:Image" src="https://www.healthylondon.org/sites/default/files/styles/large/public/healthlondon-logo-ncs1_0.png" alt=""&gt;&lt;/a&gt;
&lt;                       &lt;/div&gt;
&lt;                     &lt;/div&gt;
&lt;                   &lt;/div&gt;
&lt;                 &lt;/div&gt;
&lt;                 &lt;div id="hlp-wrapper"&gt;
248c238
&lt;             &lt;/div&gt;
---
&gt; 
</code></pre>
<p>Which is enough to produce our nice resizable banner.  Okay time to get that SSL in there.  I had thought this was going to be a real pain on Azure, but actually it&rsquo;s all pretty much Apache configuration.  Maybe I&rsquo;ll get into that tomorrow, as I suspect there will be some sticking points &hellip; I&rsquo;ve posted some notes about how I did it last time:</p>

<p><a href="https://community.bitnami.com/t/installing-certbot-for-lets-encrypt-ssl-certificate/46431/2">https://community.bitnami.com/t/installing-certbot-for-lets-encrypt-ssl-certificate/46431/2</a></p>

<p>and I need to follow up with the developer there.  Let&rsquo;s try for that in <a href="http://nonprofits.agileventures.org/2017/05/24/azure-mediawiki-stack-part4/">part 4</a> and if I&rsquo;m lucky I&rsquo;ll also get to testing the backup stuff &hellip; and also test importing all the data from the production system into the backup system &hellip;</p>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
