<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Azure MediaWiki Stack Part 2</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2017 x2017_05 x2017_05_22 x2017_05_22_azure-mediawiki-stack-part2 x2017_05_22_azure-mediawiki-stack-part2_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2017/05/22/azure-mediawiki-stack-part2/">Azure MediaWiki Stack Part 2</a></h2>
        <h5 class='date'>22 May 2017</h5>
    <p><img alt="mediawiki" src="/images/MediaWiki.svg" /></p>

<p>I wasn&rsquo;t able to complete a re-run of the NHS HLP MediaWiki installation due partly to getting distracted by other work, but also because the Parsoid service (needed by the VisualEditor) wouldn&rsquo;t install.  I was following the instructions in https://www.mediawiki.org/wiki/Parsoid/Setup but getting &ldquo;E: Unable to locate package parsoid&rdquo;.  I thrashed around, got distracted and then at the end of the day the command just worked.  I had a similar experience with letsencrypt on AsyncVoter, where the letsencrypt server was down, so maybe that was the issue with installing Parsoid, that the wikimedia releases site was down.  Anyway, next step is to configure the Parsoid service, which involved editing <code>/etc/mediawiki/parsoid/config.yaml</code> and updating the uri, which defaults to <code>http://localhost/w/api.php</code>.  After various trial and error I&rsquo;d learnt from the previous install that we needed to drop the w, like so:  </p>
<pre class="highlight plaintext"><code> # Configure Parsoid to point to your MediaWiki instances.
        mwApis:
        - # This is the only required parameter,
          # the URL of you MediaWiki API endpoint.
          uri: 'http://hlp-wiki-develop.agileventures.org/api.php'
</code></pre>
<p>Noting that we need to use <code>sudo</code> to make adjustments to this file.  Then we&rsquo;re supposed to adjust settings.js, but I could never find that file and so created it from scratch in the same directory like so:</p>
<pre class="highlight javascript"><code><span class="nx">parsoidConfig</span><span class="p">.</span><span class="nx">setMwApi</span><span class="p">({</span> <span class="na">uri</span><span class="p">:</span> <span class="s1">'http://hlp-wiki-develop.agileventures.org/api.php'</span><span class="p">,</span> <span class="na">prefix</span><span class="p">:</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="na">domain</span><span class="p">:</span> <span class="s1">'localhost'</span> <span class="p">});</span>
</code></pre>
<p>The instructions make it look like <code>prefix</code> and <code>domain</code> need updating, but the above incantation with &lsquo;localhost&rsquo; was the one that worked for me last time around.  Looking at the live system I wonder if the Parsoid service needs to run over the live domain (&#39;wiki.healthylondon.org&rsquo;) or if it could go direct to <code>bitnami-mediawiki-8a65.cloudapp.net</code>?  Maybe, maybe not, and could other configuration tweaks make the VisualEditor load a bit faster?</p>

<p>Anyhow, to get the basic VisualEditor up and running we probably need to restart the Parsoid service and add some configuration to the mediawiki instance to know where to talk to the Parsoid service.</p>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo service parsoid restart
 <span class="k">*</span> Restarting Parsoid HTTP service parsoid
Started Parsoid server on port 8142
</code></pre>
<p>brings the Parsoid server back up on port 8142, and then the following in LocalSettings.php connects the two up:</p>
<pre class="highlight php"><code>## Parsoid Config for Visual Editor

$wgVirtualRestConfig['modules']['parsoid'] = array(
        // URL to the Parsoid instance
        // Use port 8142 if you use the Debian package
        'url' =&gt; 'http://hlp-wiki-develop.agileventures.org:8142',
        // Parsoid "domain", see below (optional)
        'domain' =&gt; 'localhost',
        // Parsoid "prefix", see below (optional)
        'prefix' =&gt; 'localhost'
);
</code></pre>
<p>In principle this could all work, but we get errors like this when we try to use the VisualEditor:</p>

<p><img alt="could not find server error" src="https://www.dropbox.com/s/xr1198z72jforf0/Screenshot%202017-05-22%2010.21.31.png?dl=1" /></p>

<p>And I think the issue here is that the client JavaScript in Mediawiki is trying to contact back to the server on port 8142, which isn&rsquo;t open on the Azure box, so we need to make a change there.  This involves adding a &ldquo;Network Security Group&rdquo;:</p>

<p><img alt="adding a &quot;Network Security Group&quot;" src="https://www.dropbox.com/s/w9sb7stbq88wams/Screenshot%202017-05-22%2010.26.37.png?dl=1" /></p>

<p>and then an &ldquo;inbound security rule&rdquo;:</p>

<p><img alt="an &quot;inbound security rule&quot;" src="https://www.dropbox.com/s/59o0krege5temk9/Screenshot%202017-05-22%2010.28.20.png?dl=1" /></p>

<p>but then we still get errors like:</p>

<p><img alt="timeout reached" src="https://www.dropbox.com/s/l810011weec2vef/Screenshot%202017-05-22%2010.34.32.png?dl=1" /></p>

<p>in which case the Parsoid troubleshooting documentation is useful:</p>

<p>https://www.mediawiki.org/wiki/Parsoid/Troubleshooting#Configuration</p>

<p>Although I was stuck here for a while, but I think it comes back to the problem that it doesn&rsquo;t involve adding a security group - at least the way I got it to work last time (which took a while to figure out) was to add an extra endpoint rule to the virtual machine.  Although maybe the security group IS needed.  Blurgh, some experimentation needed here, and this whole process of documenting the setup seems to be taking just as long as figuring out the setup in the first place &hellip;!</p>

<p><img alt="adding an endpoint to the virtual machine on Azure" src="https://www.dropbox.com/s/ghzx10bnhbq7nbm/Screenshot%202017-05-22%2011.04.09.png?dl=1" /></p>

<p>Ah, so it looks like we need BOTH the endpoint AND the security group; although I&rsquo;m not 100% on that, and I think I&rsquo;m out of time to really determine that &hellip; on to <a href="http://nonprofits.agileventures.org/2017/05/23/azure-mediawiki-stack-part3/">part 3</a></p>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
