<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Azure MediaWiki Stack Part 5</title>

    <!-- Bootstrap Core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="/stylesheets/site.css" rel="stylesheet" />
    <script src="/javascripts/all.js"></script>
    <link href="/images/favicon.ico" rel="icon" type="image/ico" />
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-91621093-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body class="x2017 x2017_05 x2017_05_25 x2017_05_25_azure-mediawiki-stack-part5 x2017_05_25_azure-mediawiki-stack-part5_index">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="/#page-top"><img width="175" src="/images/av-logo-inverse.png" /></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="/#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#why-us">Why us?</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#case-studies">Case Studies</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#about">About</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#subscribe">Subscribe</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="/#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
<section id="blog">
  <div class="container">
    <div class="row">
      <div class="col-lg-2">
      </div>
      <div class="col-lg-8 text-left">
        <h2 class='title'><a href="/2017/05/25/azure-mediawiki-stack-part5/">Azure MediaWiki Stack Part 5</a></h2>
        <h5 class='date'>25 May 2017</h5>
    <p><img alt="mediawiki" src="/images/MediaWiki.svg" /></p>

<p>So, after feeling lethargic and getting distracted by only a small amount of Slack and Email, it&rsquo;s time to see if I can repeat the trick of getting the MediaWiki VisualEditor to work with https.  Maybe this is all just ridiculous yak-shaving.  I&rsquo;m getting a steady flow of spam on the wiki and I need to try out some solutions without damaging the production server.  I want to try out various things on staging before they are in production.  So yes, coherent argument for getting the staging server setup, but then the newly deployed box is on a slightly different version of MediaWiki and installing the LetsEncrypt SSL all suddenly went more smoothly, so for all my efforts to create a clone of production, will there still be differences creeping in? With technology, trivial differences in versions can lead things to break; however, driving to get that 100% match can also suck up ever increasing amounts of time &hellip;</p>

<p>Heroku&rsquo;s deploying via git with something like bundler to ensure that we have precisely the same set of libraries really does feel like a beautifully clear approach, and we can get the same from dokku.  I wonder if there&rsquo;s some similar way to deploy MediaWiki that would allow us to version all our configuration.  And how long would it take to find it and set it up? :-)</p>

<p>Task in hand - let&rsquo;s continue.  Got to log into four ssh terminals for start up &hellip; so I got distracted there (for 15mins?) and I used <code>ssh-copy-id</code> to set it up so I can log in with my private key rather than having to use the password every time.  That should save some time in the long run.</p>

<p>What I lack is a good record of exactly what changes I made to the Apache config on the production box, although comparing <code>/opt/bitnami/apache2/conf/httpd.conf</code>, I don&rsquo;t see any differences.  The version of certbot that I&rsquo;ve used this second time around has put the server certificate and key in <code>/opt/bitnami/apache2/conf</code>, but the main changes are in <code>/opt/bitnami/apache2/conf/bitnami</code>, where I did make a copy of the file <code>bitnami.conf</code>.  The initial change required is to ensure that the site is no longer served over insecure port 80:</p>
<pre class="highlight plaintext"><code>&lt;IfVersion &lt; 2.3 &gt;
  NameVirtualHost *:80 
  NameVirtualHost *:443
&lt;/IfVersion&gt;

&lt;VirtualHost _default_:80&gt;
  DocumentRoot "/opt/bitnami/apache2/htdocs"
  Redirect permanent / https://hlp-wiki-develop.agileventures.org/ # &lt;-- add this
  # ... unchanged
&lt;/VirtualHost&gt;
</code></pre>
<p>and that whenever anyone tries to access via http over port 80 that they are redirected to the secured https on port 443.  Then restart Apache:</p>
<pre class="highlight plaintext"><code>$ sudo /opt/bitnami/ctlscript.sh restart apache
</code></pre>
<p>and the site can only be accessed over https, but the problem is now that the VisualEditor won&rsquo;t work, or at least it didn&rsquo;t the first time around for me where I seemed to need to set up all sorts of port redirection, but something about this second install means I don&rsquo;t seem to have encountered this issue.  Fascinating.  I don&rsquo;t know if I screwed something up the first time around and made lots more work for myself, OR if the Bitnami stack/certbot I used has been updated.  Definitely there was a bump to the MediaWiki version and I have gone in with a different certbot command.</p>

<p>So where I&rsquo;m confused now is how good a clone I have of the first box, and the best way to upgrade the first box.  I have another layer of indirection with the first box using the wiki.healthylondon.org domain name, but I don&rsquo;t think that should affect things too seriously &hellip; is it possible that I was completely misdiagnosing the VisualEditor failures?  It&rsquo;s possible, because we had that very tricky bug where only pages with outstanding edits held in the moderation queue were blocking the editor, but I thought that was only on IE.</p>

<p>I checked the chrome developer tools network panel and all the requests to the VisualEditor are going across https.  I&rsquo;ll check on IE and then I think its time to get down to work.  I want to:</p>

<ol>
<li>clone across the data from the production server</li>
<li>run backups</li>
<li>experiment with a restore from backup</li>
<li>experiment with the spam filters suggested by the moderation extension maintainer</li>
<li>use this as a base to test out other things like defaulting create page to the VisualEditor, etc.</li>
</ol>

<p>What I&rsquo;d really like to do is have a mechanism for &ldquo;switching&rdquo; the production server to the newly created box and retiring the old one, so that I can avoid having to upgrade the boxes in place.  It seems like that switching would require DNS changes that take a long time to propagate.  I wonder if Azure has some mechanism for switching between virtual machines &hellip;?  What I&rsquo;d really like is a broader team to do this all with, but that&rsquo;d require another level of funding &hellip;</p>

        <h2 class='author'>by Sam Joseph</h2>
      </div>  
      <div class="col-lg-2">
      </div>
    </div>  
  </div>  
</section>  
<footer>
    <div class="container">
        <section id="contact">
        <div class="row">
            <div class="col-md-4">
                <h3>AgileVentures</h3>
                <p class="blurb text-muted">Our purpose is to develop better more affordable software solutions to enable non-profits to be more effective and more efficient. We also host a <a href="http://www.agileventures.org">learning community</a> around <a href="https://www.edx.org/xseries/agile-development-using-ruby-rails">free online courses</a> that enable developers to improve their team and software skills, and then to apply them on socially useful projects for non-profits. We are a Charitable Incorporated Organisation (CIO) in the UK. Ref #1170963</p>
            </div>
            <div class="col-md-4">
                <h3>What we do</h3>
                <div class="list">
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Websites</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Apps</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Process Automation</span></i>
                    <i class="fa fa-check fa-lg fa-text"><span class='font-override'>&nbsp;&nbsp;Software Projects</span></i>
                </div>
                <h4>More on our <a href="/blog">Blog</a></h4>
            </div>
            <div class="col-md-4">
                <h3>Contact Us</h3>
                <div class="contact-list">
                  <!-- <i class="fa fa-envelope fa-lg fa-text fa-fw"><span class='font-override'>&nbsp;&nbsp;</i> -->
                  <i class="fa fa-lg fa-text"><a class='mail' href='mailto:nonprofits@agileventures.org'>nonprofits@<wbr>agileventures.org</a></span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>AgileVentures</span></i>
                  <!-- <i class="fa fa-map-marker fa-lg fa-text fa-fw"></i> -->
                  <i class="fa fa-lg fa-text"><span class='font-override'>The Lodge</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>64 Pinner Road</span></i>
                  <i class="fa fa-lg fa-text"><span class='font-override'>Harrow, HA1 4HZ</span></i>
                </div>
            </div>
        </div>
        </section>
        <div class="row">
            <div class="col-md-4">
                <ul class="list-inline quicklinks">
                    <li><a href="/privacy">Privacy Policy</a>
                    </li>
                    <li><a href="/terms">Terms of Use</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <span class="copyright">Copyright &copy; AgileVentures 2017</span>
            </div>
            <div class="col-md-4">
                <ul class="list-inline social-buttons">
                    <li><a href="https://twitter.com/AgileVentures"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li><a href="https://www.facebook.com/agileventures"><i class="fa fa-facebook"></i></a>
                    </li>
                    <li><a href="https://www.linkedin.com/company/agileventures"><i class="fa fa-linkedin"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    </section>
</footer>


</body>
</html>
